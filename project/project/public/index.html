<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<link rel="stylesheet" href="css/index.css">
	<script src="js/index.js"></script>
	<body>
		<h1>添加数据</h1>
		姓名：<input onblur="isexsit()" id="addname" type="text">
		年龄：<input id="addage" type="text">
		性别：<input id="addgender" type="text">
		<button id="add-button" onclick="adddata()">提交</button>

		<h1>学生数据</h1>
		<!-- 输入姓名：<input id="searchname" type="text">
		输入年龄：<input id="searchage" type="text">
		输入性别：<input id="searchgender" type="text"> -->
		<label>检索</label>
		<select name="searchtype">
			<option value="username">姓名</option>
			<option value="userage">年龄</option>
			<option value="usergender">性别</option>
		</select>
		<input id="searchinput" type="text">
		<button id="searchbtn" onclick="search()">查找</button>
		<table>
			<thead>
				<tr>
					<th>编号</th>
					<th>姓名</th>
					<th>年龄</th>
					<th>性别</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody id="tb">

			</tbody>
		</table>

		<h1>修改数据</h1>
		<p id="updateid">id</p>
		修改姓名：<input onblur="editcheck()" id="editname" type="text">
		修改年龄：<input id="editage" type="text">
		修改性别：<input id="editgender" type="text">
		<button id="editsummit" onclick="update()">修改</button>

		<!-- <h1>查找数据</h1>
		
		<table>
			<thead>

			</thead>
			<tbody id="search">

			</tbody>
		</table>
 -->
		<script src="jquery-3.6.1.js"></script>
		<script>
			var searchdata = {};
			studelete();
			//获取列表
			function studelete() {
				$.ajax({
					url: "/index/get",
					type: "get",
					data: searchdata,
					success: function({
						msg,
						status,
						data
					}) {
						let str = data.map(item => `
						<tr>
						    <td>${item._id}</td>
							<td>${item.username}</td>
							<td>${item.userage}</td>
							<td>${item.usergender}</td>
							<td>
								<button class="editbtn" data-editstu=${item._id}>修改</button>
								<button class="delbtn" data-stuid=${item._id}>删除</button>
							</td>
						</tr>
						`)
						$("#tb").html(str);
					}
				})

			}
			//foreach获取列表，性能不及字符串拼接后一次性渲染
			/* msg.data.forEach(function(item){
				$("tbody").append(`
				<tr>
					<td>${item.name}</td>
					<td>${item.age}</td>
					<td>${item.gender}</td>
					<td>
						<button>修改</button>
						<button>删除</button>
					</td>
				</tr>`
				);
			})	
			 */

			//删除数据
			//事件委托，将动态生成标签的事件绑定在父标签上，父标签为静态标签
			$("tbody").on("click", ".delbtn", function() { //原生js this表示绑定元素，而jquery中this表示事件元素
				const _id = $(this).data("stuid"); //data(“属性名”)：获取原生属性值，属性名会自动过滤“data-”，data(“属性名“，”属性值“)：赋值
				console.log(_id);
				$.ajax({
					url: "/index/delete",
					data: {
						_id
					},
					type: "post",
					success(msg) {
						alert(`删除成功`);
						studelete();
					}
				})
			})

			//校验姓名
			function isexsit() {
				const username = $(`#addname`).val();
				$.ajax({
					url: "/index/isexsit",
					type: "post",
					data: {
						username,
					},
					success(msg) {
						if (!msg.status) {
							const result = confirm(`姓名已存在，是否继续添加`);
							if (!result) {
								$(`#add-button`).attr(`disabled`, true);
							}
						} else {
							$(`#add-button`).attr(`disabled`, false);
						}

					}
				})
			}

			//添加数据
			function adddata() {
				const username = $(`#addname`).val();
				const userage = $(`#addage`).val();
				const usergender = $(`#addgender`).val();
				$.ajax({
					url: `/index/add`,
					type: "post",
					data: {
						username,
						userage,
						usergender
					},
					success(msg) {
						$("#tb").append(`
						<tr>
						    <td>${msg._id}</td>
							<td>${msg.username}</td>
							<td>${msg.userage}</td>
							<td>${msg.usergender}</td>
							<td>
								<button class="editbtn" data-editstu=${msg._id}>修改</button>
								<button class="delbtn" data-stuid=${msg._id}>删除</button>
							</td>
						</tr>`);
					}
				})
				studelete();
			}

			//搜索
			function search() {
				const searchtype = $("select option:selected").val();
				const searchname = $("#searchinput").val();
				searchdata = {
					[searchtype]: searchname
				}
				studelete(searchdata);
				/* const username = $("#searchname").val();
				const userage = $("#searchage").val();
				const usergender = $("#searchgender").val();
				$.ajax({
					url: "/index/search",
					type: "post",
					data: {
						username,
						userage,
						usergender
					},
					success: function({
						msg,
						status,
						data
					}) {
						let str = data.map(item => `
						<tr>
						    <td>${item._id}</td>
							<td>${item.username}</td>
							<td>${item.userage}</td>
							<td>${item.usergender}</td>
							<td>
								<button class="editbtn" data-editstu=${item._id}>修改</button>
								<button class="delbtn" data-stuid=${item._id}>删除</button>
							</td>
						</tr>
						`)
						$("#search").html(str);
					}
				}) */

			}

			//修改数据-点击数据修改按钮赋值给修改输入框
			$("tbody").on("click", ".editbtn", function() {
				const _id = $(this).data("editstu");
				$.ajax({
					url: "/index/edit",
					data: {
						_id
					},
					type: "post",
					success(msg) {
						$(`#editname`).val(msg.data[0].username);
						$(`#editage`).val(msg.data[0].userage);
						$(`#editgender`).val(msg.data[0].usergender);
						$(`#updateid`).text(msg.data[0]._id)
					}
				})
			})

			//修改数据-校验姓名并更新内容至数据库
			function update() {
				const _id = $(`#updateid`).text();
				const username = $(`#editname`).val();
				const userage = $(`#editage`).val();
				const usergender = $(`#editgender`).val();
				$.ajax({
					url: "/index/isexsit",
					type: "post",
					data: {
						username,
					},
					success(msg) {
						if (!msg.status) {
							const result = confirm(`姓名已存在，是否继续修改`);
							if (!result) {
								$(`#editsummit`).attr(`disabled`, true);
								alert(`请重新输入姓名`);
							} else {
								$(`#editsummit`).attr(`disabled`, false);
								var update = {
									_id,
									username,
									userage,
									usergender
								};
								$.ajax({
									url: "/index/update",
									data: update,
									type: "post",
									success(msg) {
										studelete();
									}
								})
								alert(`修改成功`);
							}
						} else {
							var update = {
								_id,
								username,
								userage,
								usergender
							};
							$.ajax({
								url: "/index/update",
								data: update,
								type: "post",
								success(msg) {
									studelete();
								}
							})
							alert(`修改成功`);
						}
					}
				})
			}

			//修改校验数据若姓名重复按钮会至灰，重新输入姓名鼠标离开后按钮恢复可用

			function editcheck() {
				$(`#editsummit`).attr(`disabled`, false);
			}
		</script>
	</body>
</html>
